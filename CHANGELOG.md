# 📋 Changelog

本文档基于 [Keep a Changelog](https://keepachangelog.com/zh-CN/1.0.0/) 规范，
版本号遵循 [语义化版本](https://semver.org/lang/zh-CN/)。

---

## [1.5.0] - 2025-12-10

### 新增
- **API Token 管理**：支持第三方应用通过 Token 访问 API
  - 创建、启用/禁用、删除 Token
  - 支持 `read`（只读）和 `write`（读写）两种权限级别
  - 支持设置 Token 过期时间（7天/30天/90天/永久）
  - Token 创建后仅显示一次，需妥善保存
  - 三种认证方式：`Authorization: Bearer <token>`、`X-API-Key` header、`?api_key=` query
- **宝宝头像功能**：为宝宝档案设置个性化头像
  - 支持从媒体库选择或本地上传
  - 内置图片裁剪功能（缩放、平移）
  - 头像显示在顶部导航栏
  - 支持删除头像恢复默认
- **登录"记住我"功能**：
  - 勾选后会话有效期从 7 天延长至 30 天
  - 自动记住用户名，下次登录时自动填充

### 改进
- **设置页面优化**：
  - 分为三个子标签：宝宝档案、备份管理、API Token
  - 宝宝档案支持查看/编辑模式切换
  - 更清晰的信息展示布局
- **移动端导航栏**：
  - 底部导航增加「退出」按钮，便于切换账户
  - 导航栏样式优化，增加毛玻璃效果
  - 当前页面图标放大高亮
- **灯箱功能增强**：
  - 记录详情中点击图片可在该记录的图片集内左右切换
  - 相册模式使用全部图库

### 技术细节
- 新增 `api_tokens` 数据库表存储 Token 信息
- `baby` 表新增 `avatar` 字段存储头像（base64）
- 新增 `/api/tokens` CRUD 接口
- 新增 `/api/baby/avatar` 头像管理接口
- 登录接口支持 `remember` 参数

---

## [1.4.0] - 2025-11-26

### 新增
- **首次注册流程**：系统首次部署时提示设置管理员账户
  - 用户名 3-20 个字符，密码至少 6 个字符
  - 注册成功后自动登录
- **密码加密存储**：使用 SHA256 + 随机 salt 加密
  - 密码不再通过环境变量配置
  - 凭据安全存储在 SQLite 数据库中

### 改进
- **设置页面备份功能整合**：
  - 将导出/导入功能从宝宝档案设置移至备份文件管理区域
  - 统一备份相关操作入口，界面更简洁
- **移动端照片选择优化**：
  - 选择器从 `<div>` 改为 `<button>`，提升触摸精准度
  - 移动端列数从 5 列减少到 3 列
  - 限制渲染数量，解决保存按钮卡顿问题
- **移动端灯箱优化**：
  - 支持左右滑动切换照片
  - 优化触摸手势识别
- **记录页面时间轴**：
  - 使用时间轴样式展示成长记录
  - 更清晰的日期标签和数据卡片

### 移除
- 移除 `AUTH_USER`/`AUTH_PASS` 环境变量配置（改用数据库存储）

### 技术细节
- 新增 `admin_user` 数据库表存储管理员凭据
- 添加 `/api/auth/register` 注册端点
- 添加 `/api/auth/setup-status` 状态检查端点
- 更新 `docker-compose.yml` 移除明文密码配置

---

## [1.3.0] - 2025-11-26

### 新增
- **用户认证**：支持通过环境变量设置用户名密码
  - 设置 `AUTH_USER` 和 `AUTH_PASS` 环境变量启用认证
  - 登录页面与主界面风格统一
  - 会话有效期 7 天，支持退出登录
  - 未配置时保持原有无认证模式（向后兼容）
- **服务端缩略图**：使用 sharp 库生成高效缩略图
  - 200x200 WebP 格式，质量 80%
  - 自动缓存，仅在原图更新时重新生成
  - 大幅提升相册加载速度

### 技术细节
- 使用 HttpOnly Cookie 存储会话 ID
- 会话存储在内存中（重启后需重新登录）
- 缩略图缓存在 `/app/data/thumbnails` 目录
- Dockerfile 添加 `vips-dev` 依赖支持 sharp

---

## [1.2.0] - 2025-11-26

### 新增
- **相册分页加载**：每次加载50张图片，支持"加载更多"按钮，显示加载进度
- **移动端底部导航**：固定在屏幕底部的导航栏，方便单手操作
- **移动端记录卡片**：记录列表在移动端使用卡片布局，替代表格展示
- **相册日期标签吸顶**：移动端滚动时日期标签固定在顶部

### 优化
- **图片懒加载**：使用原生 `loading="lazy"` 属性优化大量图片加载
- **移动端统计卡片**：更紧凑的布局和字体大小
- **移动端成长曲线图**：调整图表高度和轴宽度，优化触摸体验
- **移动端最近记录**：优化布局，防止文字溢出
- **相册网格布局**：移动端使用4列等宽网格，桌面端使用固定尺寸

### 技术细节
- 新增 `galleryPage`、`paginatedMedia`、`paginatedMediaGrouped` 状态管理分页
- 使用 `md:` 响应式前缀区分移动端和桌面端样式
- 添加 `.mobile-nav` 和 `.main-content` CSS类处理底部导航空间

---

## [1.1.0] - 2025-11-25

### 新增
- **定时备份模式**：支持按固定时间点执行备份（如每天凌晨）
  - 间隔模式：每 N 小时自动备份
  - 定时模式：设置"每天 00:00"、"每周三 03:00"
- **备份管理**：查看备份文件列表、下载备份、删除备份、查看备份日志
- **备份状态显示**：实时显示备份模式和下次执行时间

### 修复
- 修复演示模式判断逻辑，只有"真实数据为空"时才显示演示数据
- 修复分页导航重置问题，切换分页导航时重置 galleryPage 状态
- 优化定时模式计算，修复周日（0）导致的 API 报错和分页显示

### 改进
- 备份设置 UI 优化，区分间隔模式和定时模式的配置界面
- 备份日志展示，显示最近备份的时间和文件信息

---

## [1.0.0] - 2025-11-24

### 新增
- **基础功能**
  - 宝宝档案：昵称、出生日期、性别、血型设置
  - 成长记录：身高、体重、头围定期记录
  - 数据看板：成长曲线图

- **成长记录管理**
  - 记录 CRUD 操作（增删改查）
  - 支持记录关联照片/视频
  - 记录详情查看功能

- **相册功能**
  - 照片按日期时间线展示
  - 缩略图网格浏览
  - 灯箱预览（ESC 键关闭）
  - 支持照片关联到记录

- **数据备份**
  - 完整数据导出为 `.tar.gz` 格式
  - 备份导入支持关联照片恢复（需同名）
  - 自动备份功能（定时模式）
  - 备份文件管理

- **其他特性**
  - 演示模式支持
  - 完整移动端适配

- **技术选型**
  - 后端单文件（纯 express + better-sqlite3）
  - 无构建依赖，纯 CDN 引用
  - 前端单文件（React + Tailwind + Recharts）
  - 原生 TAR+GZIP（Node.js 内置 zlib）
  - Docker 支持

---

## 版本规划

### [1.5.0] - 规划中
- [ ] 多宝宝档案支持
- [ ] 数据导出格式扩展（Excel、PDF）
- [ ] 密码修改功能

### [2.0.0] - 长期
- [ ] 多用户支持
- [ ] PWA 离线支持
- [ ] 数据云同步
